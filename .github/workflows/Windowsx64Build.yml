name: Flutter Windows Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ç›®æ ‡åˆ†æ”¯åç§°'
        required: true
        default: 'R3'  # ä¿®æ”¹æ­¤å¤„ â–¼
        type: string

      build-mode:
        description: 'æ„å»ºæ¨¡å¼'
        required: true
        type: choice
        options: 
          - debug
          - profile
          - release
      skip-signing:
        description: 'è·³è¿‡ç­¾å'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: "3.29.3"
  PROJECT_ROOT: "./src"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    # æ­¥éª¤1ï¼šåŠ¨æ€æ£€å‡ºä»£ç  â–¼
    - name: ğŸ›ï¸ æ£€å‡ºæŒ‡å®šåˆ†æ”¯
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch || 'main' }}
        path: ${{ env.PROJECT_ROOT }}

    # æ­¥éª¤2ï¼šæ¡ä»¶ç­¾åé…ç½® â–¼
    - name: ğŸ” è‡ªåŠ¨ç­¾å
      if: ${{ !inputs.skip-signing }}
      uses: GermanBluefox/code-sign-action@v7
      with:
        certificate: ${{ secrets.WINDOWS_PFX_BASE64 }}
        password: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        folder: ${{ env.PROJECT_ROOT }}/build/windows/runner/Release

    # æ­¥éª¤3ï¼šåŠ¨æ€æ„å»º â–¼
    - name: ğŸ—ï¸ æ‰§è¡Œæ„å»º
      working-directory: ${{ env.PROJECT_ROOT }}
      run: |
        flutter build windows --${{ inputs.build-mode }} \
          --dart-define=BUILD_TIMESTAMP=$(Get-Date -UFormat "%s")
