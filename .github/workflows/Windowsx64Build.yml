name: RustDesk CI

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '构建分支'
        required: true
        default: 'master'
        type: choice
        options: [master, dev]

env:
  FLUTTER_VERSION: "3.29.3"
  PROJECT_ROOT: "."  # 修复路径层级问题
  FFIGEN_VERSION: "6.1.2"
  BUILD_DIR: "build/windows/runner/Release"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    # 步骤顺序必须严格如下 ▼
    - name: 📥 检出代码
      uses: actions/checkout@v4

    - name: 🚀 优先安装Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.29.3"
        channel: stable
        architecture: x64
      env:
        PUB_CACHE: "${{ github.workspace }}/.pub_cache"  # 显式设置缓存路径

    - name: ⚙️ 配置Flutter环境
      shell: pwsh
      run: |
        # 强制刷新PATH
        $env:Path += ";$env:FLUTTER_HOME\bin"
        flutter config --disable-telemetry
        flutter doctor -v

    - name: 📦 安装依赖
      run: |
        flutter pub get --verbose
