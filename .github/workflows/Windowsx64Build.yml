name: RustDesk CI

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'æ„å»ºåˆ†æ”¯'
        required: true
        default: 'master'
        type: choice
        options: [master, dev]

env:
  FLUTTER_VERSION: "3.29.3"
  PROJECT_ROOT: "."  # ä¿®å¤è·¯å¾„å±‚çº§é—®é¢˜
  FFIGEN_VERSION: "6.1.2"
  BUILD_DIR: "build/windows/runner/Release"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        # ç¦ç”¨Telemetry
        flutter config --disable-telemetry
        # è®¾ç½®Javaç¯å¢ƒ
        echo "JAVA_HOME=C:\hostedtoolcache\windows\Java_Temurin-Hotspot_jdk\8.0.442-6\x64" >> $env:GITHUB_ENV

    - name: ğŸ“¥ åŠ¨æ€æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        path: src  # ä¿®å¤ä¸‰çº§ç›®å½•é—®é¢˜
        ref: ${{ github.event.inputs.branch || 'master' }}

    - name: ğŸ”„ ä¿®å¤pubspec.yamlç»“æ„
      run: |
        # å°†ffigenç§»åŠ¨åˆ°dev_dependenciesä¸‹
        (Get-Content src/pubspec.yaml) -replace 'flutter:', 'dev_dependencies:' | Set-Content src/pubspec.yaml
        Add-Content -Path src/pubspec.yaml "`n  ffigen: ^${{ env.FFIGEN_VERSION }}"

    - name: ğŸš€ Flutterç¯å¢ƒå®‰è£…
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: stable
        architecture: x64

    - name: ğŸ“¦ ä¾èµ–å®‰è£…
      working-directory: src
      run: |
        flutter pub upgrade --major-versions
        flutter pub get --verbose

    - name: ğŸ—ï¸ æ„å»ºWindowsåº”ç”¨
      working-directory: src
      run: |
        flutter build windows --release --dart-define=ARCH=x64
        if not exist ${{ env.BUILD_DIR }}/rustdesk.exe (
          echo "::error::æ„å»ºå¤±è´¥ï¼å¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        )

    - name: ğŸ” è‡ªåŠ¨ç­¾å
      if: success()
      uses: GermanBluefox/code-sign-action@v7
      with:
        certificate: ${{ secrets.WINDOWS_PFX_BASE64 }}
        password: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        folder: src/${{ env.BUILD_DIR }}
