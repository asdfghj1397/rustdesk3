name: Flutter Windows Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '目标分支名称'
        required: true
        default: 'R3'  # 修改此处 ▼
        type: string

      build-mode:
        description: '构建模式'
        required: true
        type: choice
        options: 
          - debug
          - profile
          - release
      skip-signing:
        description: '跳过签名'
        required: false
        type: boolean
        default: false

env:
  FLUTTER_VERSION: "3.29.3"
  PROJECT_ROOT: "./src"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    # 步骤1：动态检出代码 ▼
    - name: 🛎️ 检出指定分支
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch || 'main' }}
        path: ${{ env.PROJECT_ROOT }}

    # 步骤2：条件签名配置 ▼
    - name: 🔐 自动签名
      if: ${{ !inputs.skip-signing }}
      uses: GermanBluefox/code-sign-action@v7
      with:
        certificate: ${{ secrets.WINDOWS_PFX_BASE64 }}
        password: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        folder: ${{ env.PROJECT_ROOT }}/build/windows/runner/Release

    # 步骤3：动态构建 ▼
    - name: 🏗️ 执行构建
      working-directory: ${{ env.PROJECT_ROOT }}
      run: |
        flutter build windows --${{ inputs.build-mode }} \
          --dart-define=BUILD_TIMESTAMP=$(Get-Date -UFormat "%s")
