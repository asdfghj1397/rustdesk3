name: RustDesk Universal Build

on:
  # æ‰‹åŠ¨è§¦å‘é…ç½®ï¼ˆæ— éœ€å‚æ•°ï¼‰
  workflow_dispatch: {}

jobs:
  windows-build:
    name: ðŸªŸ Windows 64ä½æž„å»º
    runs-on: windows-latest  # å¿…é¡»ä½¿ç”¨WindowsçŽ¯å¢ƒ
    steps:
    - name: ðŸ›Žï¸ æ™ºèƒ½æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}  # è‡ªåŠ¨è¯†åˆ«è§¦å‘åˆ†æ”¯
        fetch-depth: 0  # å®Œæ•´å…‹éš†åŽ†å²
        clean: true     # æ¸…ç†æ®‹ç•™æ–‡ä»¶

    - name: ðŸ› ï¸ å®‰è£…Rustå·¥å…·é“¾
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        target: x86_64-pc-windows-msvc  # å…³é”®å¹³å°å‚æ•°
        override: true

    - name: ðŸ”§ ç¼–è¯‘Releaseç‰ˆæœ¬
      run: |
        cargo build --release --target x86_64-pc-windows-msvc
        # éªŒè¯ç”Ÿæˆæ–‡ä»¶
        ls target/x86_64-pc-windows-msvc/release/*.exe

    - name: ðŸ“¦ ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-windows-bin
        path: |
          target/x86_64-pc-windows-msvc/release/rustdesk.exe
          target/x86_64-pc-windows-msvc/release/*.dll

  linux-build:
    name: ðŸ§ Linuxæž„å»º
    runs-on: ubuntu-latest
    needs: windows-build  # é¡ºåºæ‰§è¡Œ
    steps:
    - name: ðŸ›Žï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref_name }}

    - name: ðŸ“¦ ä¸‹è½½Windowsåˆ¶å“
      uses: actions/download-artifact@v3
      with:
        name: rustdesk-windows-bin
        path: target/win-bin

    - name: ðŸ“ ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "åˆ†æ”¯: ${{ github.ref_name }}" > build-info.md
        echo "æäº¤: ${{ github.sha }}" >> build-info.md
        echo "æž„å»ºæ—¶é—´: $(date)" >> build-info.md
        ls -R target >> build-info.md

    - name: ðŸ“¤ ä¸Šä¼ å®Œæ•´æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: build-reports
        path: |
          build-info.md
          target/win-bin/*
