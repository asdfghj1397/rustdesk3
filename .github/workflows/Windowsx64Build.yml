name: RustDesk Windows x64 Build

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å…¥å£

env:
  FLUTTER_VERSION: "3.10.6"
  FLUTTER_RUST_BRIDGE_VERSION: "1.75.3"
  FFIGEN_VERSION: "6.1.2"  # æ–°å¢ffigenç‰ˆæœ¬æ§åˆ¶
  BUILD_DIR: "flutter/build/windows/runner/Release"

jobs:
  build-windows-x64:
    runs-on: windows-2019
    steps:
    - name: ğŸ› ï¸ åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        # è®¾ç½®ffigenç‰ˆæœ¬
        echo "FFIGEN_VERSION=${{ env.FFIGEN_VERSION }}" >> $env:GITHUB_ENV

    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: ğŸš€ å®‰è£…Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: stable
        architecture: x64

    - name: ğŸ“¦ æ›´æ–°Dartä¾èµ–
      run: |
        # åœ¨pubspec.yamlä¸­å¼ºåˆ¶æŒ‡å®šffigenç‰ˆæœ¬
        Add-Content -Path flutter/pubspec.yaml "`n  ffigen: ^${{ env.FFIGEN_VERSION }}"
        cd flutter
        flutter pub upgrade --major-versions

    - name: ğŸ”— ç”Ÿæˆæ¡¥æ¥ä»£ç 
      run: |
        # ä¿®æ­£ç”Ÿæˆè·¯å¾„
        cargo install flutter_rust_bridge_codegen --version ${{ env.FLUTTER_RUST_BRIDGE_VERSION }}
        flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart
        
        # ç¡®ä¿bridge_generatedæ–‡ä»¶å­˜åœ¨
        if not exist src/bridge_generated.rs (
          echo "::error::æ¡¥æ¥ä»£ç ç”Ÿæˆå¤±è´¥ï¼"
          exit 1
        )

    - name: ğŸ”¨ æ„å»ºRustç»„ä»¶
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: x86_64-pc-windows-msvc
        override: true

    - name: ğŸ—ï¸ æ‰§è¡Œå®Œæ•´æ„å»º
      run: |
        python build.py --portable --hwcodec --flutter --feature IddDriver
        
        # éªŒè¯å…³é”®æ–‡ä»¶
        if not exist ${{ env.BUILD_DIR }}/rustdesk.exe (
          echo "::error::å¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆï¼"
          exit 1
        )

    - name: ğŸ” ä»£ç ç­¾å
      if: ${{ always() }}
      uses: GermanBluefox/code-sign-action@v7
      with:
        certificate: '${{ secrets.WINDOWS_PFX_BASE64 }}'
        password: '${{ secrets.WINDOWS_PFX_PASSWORD }}'
        folder: ${{ env.BUILD_DIR }}
