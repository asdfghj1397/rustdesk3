name: RustDesk CI

on:
  workflow_dispatch:
    inputs:
      branch:
        description: '构建分支'
        required: true
        default: 'master'
        type: choice
        options: [master, dev]

env:
  FLUTTER_VERSION: "3.29.3"
  PROJECT_ROOT: "."  # 修复路径层级问题
  FFIGEN_VERSION: "6.1.2"
  BUILD_DIR: "build/windows/runner/Release"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: 🛠️ 初始化环境
      run: |
        # 禁用Telemetry
        flutter config --disable-telemetry
        # 设置Java环境
        echo "JAVA_HOME=C:\hostedtoolcache\windows\Java_Temurin-Hotspot_jdk\8.0.442-6\x64" >> $env:GITHUB_ENV

    - name: 📥 动态检出代码
      uses: actions/checkout@v4
      with:
        path: src  # 修复三级目录问题
        ref: ${{ github.event.inputs.branch || 'master' }}

    - name: 🔄 修复pubspec.yaml结构
      run: |
        # 将ffigen移动到dev_dependencies下
        (Get-Content src/pubspec.yaml) -replace 'flutter:', 'dev_dependencies:' | Set-Content src/pubspec.yaml
        Add-Content -Path src/pubspec.yaml "`n  ffigen: ^${{ env.FFIGEN_VERSION }}"

    - name: 🚀 Flutter环境安装
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: stable
        architecture: x64

    - name: 📦 依赖安装
      working-directory: src
      run: |
        flutter pub upgrade --major-versions
        flutter pub get --verbose

    - name: 🏗️ 构建Windows应用
      working-directory: src
      run: |
        flutter build windows --release --dart-define=ARCH=x64
        if not exist ${{ env.BUILD_DIR }}/rustdesk.exe (
          echo "::error::构建失败！可执行文件未生成"
          exit 1
        )

    - name: 🔐 自动签名
      if: success()
      uses: GermanBluefox/code-sign-action@v7
      with:
        certificate: ${{ secrets.WINDOWS_PFX_BASE64 }}
        password: ${{ secrets.WINDOWS_PFX_PASSWORD }}
        folder: src/${{ env.BUILD_DIR }}
